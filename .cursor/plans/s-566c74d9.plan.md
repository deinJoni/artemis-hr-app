<!-- 566c74d9-2979-44a9-a43e-da838f888c1a c2839453-f5c9-4d9f-88b8-0e0c1ea0e472 -->
# Artemis SaaS Data Alignment Plan

## Goals

- Expose the existing multi-tenant, RBAC-enabled schema to users through Settings, Members, and Employees UI.
- Add backend endpoints that respect RLS and validate with shared zod schemas.
- Keep types centralized in `@vibe/shared`. Use `pnpm` and current Hono/React Router structure.

## Scope

- Frontend (apps/frontend): new routes `settings`, `members`, `employees`, sidebar links, and integrations.
- Backend (apps/backend): REST endpoints for tenants update, memberships management, and employees CRUD.
- Shared (packages/shared): zod schemas/types for Membership, Employee, and Tenants update payloads.
- Supabase: reuse current RLS/policies (no new migrations initially).

## Key Files to Update/Create

- Frontend
- `apps/frontend/app/routes.ts` (add routes)
- `apps/frontend/app/components/app-sidebar.tsx` (add nav links)
- `apps/frontend/app/routes/settings.tsx` (tenant settings form)
- `apps/frontend/app/routes/members.tsx` (team management)
- `apps/frontend/app/routes/employees.tsx` (employees list/CRUD)
- Backend
- `apps/backend/src/index.ts` (register new routes) and/or add route modules under `apps/backend/src/`:
  - `tenants.ts` (GET current, PUT update)
  - `memberships.ts` (GET list, POST invite/add existing, PUT role, DELETE remove)
  - `employees.ts` (GET list, POST create, PUT update, DELETE)
- Shared
- `packages/shared/src/index.ts` (add schemas)
- `packages/shared/src/database.types.ts` (already reflects DB; no edits expected)

## Backend APIs (Hono)

- Tenants
- GET `/api/tenants/me` → current user's primary tenant (from `profiles` join `tenants`)
- PUT `/api/tenants/:id` → update allowed fields: `company_name`, `company_location`, `company_size`, `contact_name`, `contact_email`, `contact_phone`, `needs_summary`, `key_priorities`
- Memberships
- GET `/api/memberships/:tenantId` → list memberships with user email (server-side join to `auth.users` using service key)
- POST `/api/memberships/:tenantId` → add existing user by `user_id` with `role`
- PUT `/api/memberships/:tenantId/:userId` → change `role`
- DELETE `/api/memberships/:tenantId/:userId` → remove member
- Employees (example domain)
- GET `/api/employees/:tenantId`
- POST `/api/employees/:tenantId`
- PUT `/api/employees/:tenantId/:id`
- DELETE `/api/employees/:tenantId/:id`

All inputs/outputs validated with zod from `@vibe/shared`. Authorize with Supabase JWT; rely on RLS where possible; server may enforce extra checks using `app_has_permission` if needed.

## Frontend Routes (React Router 7)

- `settings.tsx`: Loader fetches `/api/tenants/me`. Form edits allowed fields and submits to PUT endpoint.
- `members.tsx`: Loader fetches memberships; table with role select and remove actions; simple “Add member by user ID” for MVP. (Email invite can be a follow-up.)
- `employees.tsx`: Table + create/edit modal. Persist via employees endpoints.
- Update `app-sidebar.tsx` to include links to these routes.
- After adding routes/types: run `pnpm --filter frontend typecheck` to refresh route types.

## Data Validation (packages/shared)

- Add schemas:
- `TenantUpdateInputSchema`
- `MembershipSchema`, `MembershipListResponseSchema`, `MembershipCreateInputSchema`, `MembershipUpdateInputSchema`
- `EmployeeSchema`, `EmployeeListResponseSchema`, `EmployeeCreateInputSchema`, `EmployeeUpdateInputSchema`

## Risks & Mitigations

- auth.users join for emails requires service key: handle only in backend API.
- Membership invites by email not in scope; add later as optional enhancement.
- Ensure RLS alignment: we already have policies for tenants update (admins) and memberships/ employees.

## Rollout

- Implement shared types → backend endpoints → frontend pages → wire sidebar → manual QA.
- Keep edits small and incremental per route/module.

## Commands

- Dev: `pnpm dev` (turbo), or `pnpm --filter backend dev` and `pnpm --filter frontend dev`
- Typecheck: `pnpm typecheck` or per app
- Lint: `pnpm lint`

### To-dos

- [ ] Add zod schemas for tenant update, memberships, employees in @vibe/shared
- [ ] Implement GET /api/tenants/me and PUT /api/tenants/:id in backend
- [ ] Implement memberships list/create/update/delete endpoints
- [ ] Implement employees list/create/update/delete endpoints
- [ ] Create settings page to edit tenant fields
- [ ] Create members page to list/change roles/remove/add existing users
- [ ] Create employees page with table and CRUD modals
- [ ] Add Settings, Members, Employees links to app sidebar
- [ ] Integrate shared zod validation and types across frontend/backend
- [ ] Run typecheck and lint; fix any issues